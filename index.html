<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GMod Загрузка</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            color: #e0e0e0;
            overflow: hidden;
        }

        .loading-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 1s ease-in-out;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        /* Панель загрузки с прогресс-баром */
        .download-panel {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            border-top: 2px solid #ff9900;
            border-radius: 8px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            color: #fff;
            padding: 16px 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .download-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ff9900;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .download-header span {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #ff9900;
            border-radius: 2px;
        }

        /* Прогресс-бар */
        .progress-container {
            width: 100%;
            height: 24px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff9900, #ffcc66);
            border-radius: 12px;
            box-shadow: 0 0 10px #ff9900;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #ddd;
            margin-bottom: 5px;
        }

        .current-file {
            font-size: 13px;
            color: #ff9900;
            background: rgba(255, 153, 0, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            border-left: 3px solid #ff9900;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-files {
            color: #888;
            font-style: italic;
            padding: 4px 0;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .downloading-active {
            animation: pulse 1.5s infinite;
            color: #ff9900;
        }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingContainer">
        <div class="overlay"></div>

        <div class="download-panel">
            <div class="download-header">
                <span></span> ЗАГРУЗКА РЕСУРСОВ
            </div>

            <!-- Прогресс-бар -->
            <div class="progress-container">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>

            <div class="progress-info">
                <span id="progressPercent">0%</span>
                <span id="fileCounter">0 / 0</span>
            </div>

            <!-- Текущий загружаемый файл -->
            <div class="current-file" id="currentFile">Ожидание...</div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // --- Смена фоновых изображений (как и раньше) ---
            const backgroundImages = [
                'index1.jpg',
                'index2.jpg',
                'index3.jpg',
                'index4.jpg'
            ].filter(name => name);

            const container = document.getElementById('loadingContainer');
            let currentIndex = 0;

            function changeBackground() {
                if (!container) return;
                if (backgroundImages.length > 0) {
                    container.style.backgroundImage = `url('${backgroundImages[currentIndex]}')`;
                    currentIndex = (currentIndex + 1) % backgroundImages.length;
                } else {
                    container.style.backgroundImage = 'linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%)';
                }
            }
            changeBackground();
            if (backgroundImages.length > 1) {
                setInterval(changeBackground, 6000);
            }

            // --- Логика прогресса загрузки ---
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const fileCounter = document.getElementById('fileCounter');
            const currentFileEl = document.getElementById('currentFile');

            let totalFiles = 0;          // общее количество файлов для загрузки
            let remainingFiles = 0;       // сколько ещё нужно скачать

            function updateProgress() {
                let percent = 0;
                if (totalFiles > 0) {
                    percent = Math.min(100, Math.max(0, ((totalFiles - remainingFiles) / totalFiles) * 100));
                }
                progressFill.style.width = percent + '%';
                progressPercent.textContent = Math.round(percent) + '%';
                fileCounter.textContent = (totalFiles - remainingFiles) + ' / ' + totalFiles;
            }

            // Вызывается при изменении списка скачиваемых файлов (передаётся массив оставшихся)
            window.DownloadablesChanged = function(files) {
                console.log('DownloadablesChanged', files);
                if (!files || !Array.isArray(files)) return;

                remainingFiles = files.length;

                // Показываем первый файл из списка как "текущий"
                if (remainingFiles > 0) {
                    currentFileEl.textContent = files[0] || 'Неизвестный файл';
                } else {
                    currentFileEl.textContent = 'Загрузка завершена';
                }

                updateProgress();
            };

            // Вызывается с общим количеством файлов (и иногда массивом)
            window.NumDownloadables = function(num, files) {
                console.log('NumDownloadables', num, files);
                if (typeof num === 'number' && num >= 0) {
                    totalFiles = num;
                }
                if (files && Array.isArray(files)) {
                    remainingFiles = files.length;
                    if (remainingFiles > 0) {
                        currentFileEl.textContent = files[0] || 'Неизвестный файл';
                    } else {
                        currentFileEl.textContent = 'Загрузка завершена';
                    }
                } else {
                    // Если массив не передан, попробуем получить имена через TranslateDownloadableName
                    const names = [];
                    for (let i = 0; i < totalFiles; i++) {
                        if (window.TranslateDownloadableName) {
                            try {
                                names.push(window.TranslateDownloadableName(i) || `Файл ${i+1}`);
                            } catch (e) {
                                names.push(`Файл ${i+1}`);
                            }
                        } else {
                            names.push(`Файл ${i+1}`);
                        }
                    }
                    // Предполагаем, что все ещё загружаются (если нет доп. информации)
                    // Но лучше использовать предыдущее значение remainingFiles, если оно было установлено
                    if (remainingFiles === 0 && totalFiles > 0) {
                        remainingFiles = totalFiles; // первая инициализация
                    }
                    if (remainingFiles > 0) {
                        currentFileEl.textContent = names[0] || 'Файл...';
                    }
                }
                updateProgress();
            };

            window.UpdateDownloadables = function() {
                console.log('UpdateDownloadables');
                if (window.GetDownloadables && typeof window.GetDownloadables === 'function') {
                    try {
                        const files = window.GetDownloadables();
                        if (files && Array.isArray(files)) {
                            remainingFiles = files.length;
                            if (remainingFiles > 0) {
                                currentFileEl.textContent = files[0] || 'Неизвестный файл';
                            } else {
                                currentFileEl.textContent = 'Загрузка завершена';
                            }
                            updateProgress();
                        }
                    } catch (e) {}
                }
            };

            // Заглушка для TranslateDownloadableName
            if (!window.TranslateDownloadableName) {
                window.TranslateDownloadableName = function(index) {
                    return `resource_${index}.dat`;
                };
            }

            // Демо-режим для браузера
            setTimeout(function() {
                if (!window.GetDownloadables) {
                    // Имитация загрузки
                    totalFiles = 10;
                    remainingFiles = 7;
                    currentFileEl.textContent = 'maps/demo_map.bsp';
                    updateProgress();

                    // Для демонстрации обновлений
                    let demoCount = 0;
                    setInterval(function() {
                        if (remainingFiles > 0) {
                            remainingFiles--;
                            currentFileEl.textContent = `file_${remainingFiles}.dat`;
                            updateProgress();
                        }
                    }, 2000);
                }
            }, 500);
        })();
    </script>
</body>
</html>
